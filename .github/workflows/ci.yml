name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.23']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('cli/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: cd cli && go mod download

    - name: Verify dependencies
      run: cd cli && go mod verify

    - name: Run tests
      run: cd cli && go test -v -race -coverprofile=coverage.out ./...

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      if: matrix.go-version == '1.23'
      with:
        file: ./cli/coverage.out
        flags: unittests
        name: codecov-umbrella

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m
        working-directory: ./cli
        only-new-issues: false

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.23']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Get version
      id: get_version
      shell: bash
      run: |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

    - name: Set build variables
      id: build_vars
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          echo "goos=linux" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          echo "goos=darwin" >> $GITHUB_OUTPUT
        else
          echo "goos=windows" >> $GITHUB_OUTPUT
        fi
        
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "binary_name=reconify.exe" >> $GITHUB_OUTPUT
        else
          echo "binary_name=reconify" >> $GITHUB_OUTPUT
        fi

    - name: Build binary
      shell: bash
      run: |
        cd cli
        GOOS=${{ steps.build_vars.outputs.goos }} \
        GOARCH=amd64 \
        go build -ldflags "-X main.Version=${{ steps.get_version.outputs.version }} -X main.BuildTime=${{ steps.get_version.outputs.build_time }}" \
        -o ../${{ steps.build_vars.outputs.binary_name }} \
        ./cmd/reconify

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: reconify-${{ matrix.os }}
        path: ${{ steps.build_vars.outputs.binary_name }}

  nodejs:
    name: Node.js
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Type check docs
      run: pnpm --filter docs types:check

    - name: Lint docs
      run: pnpm --filter docs lint
      continue-on-error: true

    - name: Lint other packages
      run: pnpm --filter '{api,dashboard}' lint
      continue-on-error: true

    - name: Test packages
      run: pnpm -r test
      continue-on-error: true

    - name: Build docs
      run: pnpm --filter docs build

    - name: Build other packages
      run: pnpm --filter '{api,dashboard}' build
      continue-on-error: true

